ACCION RECPAR2 ()ES
AMBIENTE
	RFECHA: REGISTRO
		DD: AN()
		MM: AN()
		AA: AN()
	FINREGISTRO
	
	RCLAVE: REGISTRO
		NU_TRAN: N(8)
		NU_CLIENTE: N(5)
		NU_VENDEDOR: N(5)
		FECHA_TR: RFECHA
	FINREGISTRO

	REG1: REGISTRO
		CLAVE:RCLAVE
		COSTO_TR: N(7,2)
		UBI: AN(50)
		PUNT: AN(1)
		OP: N(1)
	FINREGISTRO

	REG2: REGISTRO
		NU_VEND: N(5)
		NYA:AN(50)
		PUNT: N(1,1)
		CANT_VENT: N(7)
		OP: N(1,1)
		TIPO_MERLIBRE: AN(1)
	FINREGISTRO

	ARCHVEN: ARCHIVO DE REG1 ORDENADO POR CLAVE

	ARCHTRANSACCIONES: ARCHIVO DE REG1 ORDENADO POR CLAVE.NU_TRAN

	ARCHVENDEDORES: ARCHIVO DE REG2 INDEXADO POR NU_VENDEDOR

	SAL: ARCHIVO DE REG1 ORDENADO POR CLAVE

	REG_VEN: REG1
	REG_TRANS: REG1
	REG_INDEX: REG2
	REG_SAL: REG1

	PROCEDIMIENTO LEER_VENTAS () ES
		LEER (ARCHVEN, REG_VEN)
		SI FDA(ARCHVEN) ENTONCES
			REG_VEN.CLAVE: HV
		FINSI
	FINSUBACCION

	PROCEDIMIENTO LEER_TRANS () ES
		LEER (ARCHTRANSACCIONES, REG_TRANS)
		SI FDA(ARCHTRANSACCIONES) ENTONCES
			REG_TRANS.CLAVE: HV
		FINSI
	FINSUBACCION

	PROCEDIMIENTO ACTUALIZACION() ES

		SI (REG_VEN.CLAVE > REG_TRANS.CLAVE) ENTONCES
			ESC (SAL, REG_TRANS)
			LEER_TRANS()
		SINO
			SI (REG_VEN.CLAVE < REG_TRANS.CLAVE) ENTONCES
				ESC (SAL, REG_VEN)
				LEER_VENTAS()
			SINO
				REGSAL:= REG_TRANS
				ESC(SAL,REG_SAL)
				LEER_VENTAS()
				LEER_TRANS()
			FINSI
		FINSI

	FINPROCEDIMIENTO

	PROCEDIMIENTO ACT_INDEX() ES
		REG_INDEX.NU_VENDEDOR:=REG_TRANS.NU_VENDEDOR
		LEER(ARCHVENDEDORES,REG_INDEX)
			
			SI NO EXISTE ENTONCES
			
				ESC("INGRESE NYA DEL VENDEDOR: "),LEER (REG_INDEX.NYA)
				REG_INDEX.PUNT:= REG_TRANS.PUNT
				REG_INDEX.OP:= REG_TRANS.OP
				REG_INDEX.TIPO_MERLIBRE:= "S"
				GRABAR(ARCHVENDEDORES,REG_INDEX)
			
			SINO

				SI (REG_TRANS.NU_CLIENTE = NULL)Y(REG_TRANS.FECHA_TR = NULL) ENTONCES
					BORRAR(ARCHVENDEDORES, REG_INDEX)
				FINSI
					REG_INDEX.CANT_VENT:=REG_INDEX.CANT_VENT + 1
				REG_INDEX.PUNT:= (REG_INDEX.PUNT+1) DIV REG.CANT_VENT
				REG_INDEX.OP:= (REG_INDEX.OP+1) DIV REG.CANT_VENT
				SEGUN CANT_VENT HACER
					<100: REG_INDEX.TIPO_MERLIBRE:= "S"
					<500: REG_INDEX.TIPO_MERLIBRE:= "P"
					>500: REG_INDEX.TIPO_MERLIBRE:= "G"
				FINSEGUN
				REGRABAR(ARCHVENDEDORES,REG_INDEX)

			FINSI
	FINPROCEDIMIENTO

PROCESO
	ABRIR E/(ARCHVEN)
	ABRIR E/(ARCHTRANSACCIONES)
	ABRIR /S (SAL)
	ABRIR E/S(ARCHVENDEDORES)

	LEER_TRANS()
	LEER_VENTAS()

	MIENTRAS (REG1.CLAVE <> HV) O (REG1.CLAVE <> HV) HACER

		ACT_INDEX()
		ACTUALIZACION()
	
	FINMIENTRAS

	CERRAR(ARCHVENDEDORES)
	CERRAR(ARCHTRANSACCIONES)
	CERRAR(ARCHVEN)
	CERRAR(SAL)
	
FINACCION